name: Spring Boot CI/CD with Database Migration

on:
  push:
    branches: [ master ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:latest
        env:
          MYSQL_ROOT_PASSWORD: secret
          MYSQL_DATABASE: your_db
        ports:
          - 3306:3306
        options: --health-cmd="mysqladmin ping" --health-interval=10s --health-timeout=5s --health-retries=3

    steps:
    - name: Setup Java and Maven
      uses: actions/setup-java@v2
      with:
        distribution: 'adopt'
        java-version: '11'

    - name: Run Database Migrations
      run: mvn flyway:migrate
      env:
        FLYWAY_URL: jdbc:mysql://mysql:3306/your_db
        FLYWAY_USER: root
        FLYWAY_PASSWORD: secret

    - name: Login to Docker Hub
      run: echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

    - name: Push Custom MySQL Image
      run: docker push mucansu/foodtinder_db:latest
